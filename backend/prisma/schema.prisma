// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("TEST_DATABASE_URL")
}





enum OrganizationType { 
  ENTERPRISE
  ASSOCIATION
  SCHOOL
  CLUB
  OTHER
}

enum QuizDifficulty {
  EASY
  MEDIUM 
  HARD
}

enum QuizRoomStatus {
  OPEN
  CLOSED
}

enum QuestionType {
  MULTIPLE_CHOICE
  ORDERING
  INTRUDER
  ASSOCIATION
  BLIND_TEST
}


model User {
  id        Int     @id @default(autoincrement())
  username  String  @unique @db.VarChar(30)
  email     String  @unique @db.VarChar(191)
  password  String  @db.VarChar(255)
  totalExp Int @default(0) @map("total_exp")
  isAdmin   Boolean @default(false) @map("is_admin")
  profileImage String? @db.VarChar(255) @map("profile_image")
  isActive  Boolean @default(true)  @map("is_active")

  lastLogin DateTime? @map("last_login") @db.Timestamp(0) 
  updatedAt DateTime? @map("updated_at") @db.Timestamp(0)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamp(0)

  organizationsCreated Organization[]        @relation("OrganizationCreatedBy")
  badgesCreated        Badge[]               @relation("BadgeCreatedBy")
  icebreakersCreated   Icebreaker[]          @relation("IcebreakerCreatedBy")
  orgMessages          OrganizationMessage[] @relation("OrgMessageByUser")
  quizzesCreated       Quiz[]                @relation("QuizCreatedBy")
  quizRoomsCreated     QuizRoom[]            @relation("QuizRoomCreatedBy")
  servicesCreated      Service[]             @relation("ServiceCreatedBy")
  teamsCreated         Team[]                @relation("TeamCreatedBy")

  userBadges            UserBadge[]
  userTeams             UserTeam[]
  userOrganizationRoles UserOrganizationRole[]

  @@map("users")
}

model Organization {
  id               Int              @id @default(autoincrement())
  name             String           @db.VarChar(255)
  description      String?
  logo             String?          @db.VarChar(255)
  organizationType OrganizationType @map("organization_type")
  maxMembers       Int?             @map("max_members")

  createdById Int?     @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  createdBy   User? @relation("OrganizationCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)      

  badges      Badge[]
  icebreakers Icebreaker[]
  messages    OrganizationMessage[]
  services    Service[]
  teams       Team[]
  quizzes     Quiz[]
  quizRooms   QuizRoom[]

  userOrganizationRoles UserOrganizationRole[]

  @@index([createdById])
  @@map("organization")
}

model Theme {
  id    Int    @id @default(autoincrement())
  name  String @unique @db.VarChar(100)

  quizzes Quiz[]

  @@map("theme")
}


model Quiz {
  id                 Int            @id @default(autoincrement())
  title              String         @db.VarChar(255)
  difficulty         QuizDifficulty @default(EASY)
  description        String?        @db.VarChar(255)
  secondsPerQuestion Int?           @map("seconds_per_question")

  themeId       Int? @map("theme_id") 
  organizationId Int?     @map("organization_id")
  isScheduled    Boolean  @default(false) @map("is_scheduled")
  scheduledAt    DateTime? @map("scheduled_at") @db.Timestamp(0)

  createdById Int?     @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User?         @relation("QuizCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)
  theme   Theme? @relation(fields: [themeId], references: [id], onDelete: SetNull)

  questions Question[]
  quizRooms  QuizRoom[]

  @@index([organizationId])
  @@index([createdById])
  @@index([themeId]) 
  @@map("quiz")
}

model Question {
  id     Int    @id @default(autoincrement())
  quizId Int?   @map("quiz_id")
  type   QuestionType @default(MULTIPLE_CHOICE)
  text   String @db.VarChar(255)

  quiz    Quiz?    @relation(fields: [quizId], references: [id], onDelete: Cascade)
  answers Answer[]
  pairs   AnswerPair[]

  @@index([quizId])
  @@map("question")
}

model Answer {
  id         Int     @id @default(autoincrement())
  questionId Int    @map("question_id") 
  text       String
  isCorrect  Boolean @map("is_correct")

  orderIndex Int?     @map("order_index")

  question Question? @relation(fields: [questionId], references: [id], onDelete: Cascade) 

  @@index([questionId])
  @@unique([questionId, orderIndex])
  @@map("answer")
}

model AnswerPair {
  id         Int    @id @default(autoincrement())
  questionId Int    @map("question_id")

  leftElement  String @map("left_element")  @db.VarChar(120)
  rightElement String @map("right_element") @db.VarChar(120)

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@unique([questionId, leftElement, rightElement])
  @@map("answer_pair")
}


model Badge {
  id             Int      @id @default(autoincrement())
  name           String   @db.VarChar(255)
  description    String?
  icon           String?  @db.VarChar(255)

  organizationId Int   @map("organization_id")
  createdById    Int?  @map("created_by") 
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("BadgeCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  userBadges UserBadge[]

  @@index([organizationId])
  @@index([createdById])
  @@map("badge")
}

model Icebreaker {
  id             Int      @id @default(autoincrement())
  organizationId Int      @map("organization_id")
  content        String
  createdById    Int?     @map("created_by")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("IcebreakerCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([createdById])
  @@map("icebreaker")
}

model OrganizationMessage {
  id             Int      @id @default(autoincrement())
  organizationId Int      @map("organization_id")
  userId         Int?     @map("user_id")
  content        String
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation("OrgMessageByUser", fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([userId])
  @@map("organization_message")
}

model QuizRoom {
  id             Int            @id @default(autoincrement())
  organizationId Int            @map("organization_id")
  quizId          Int?          @map("quiz_id")
  status         QuizRoomStatus @default(OPEN)

  createdById Int?     @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  quiz         Quiz?        @relation(fields: [quizId], references: [id], onDelete: SetNull)
  createdBy    User?        @relation("QuizRoomCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  @@index([organizationId])
  @@index([quizId])
  @@index([createdById])
  @@map("quiz_room")
}

model Service {
  id             Int      @id @default(autoincrement())
  name           String   @db.VarChar(255)
  description    String?
  organizationId Int      @map("organization_id")

  createdById Int?     @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  createdBy    User?        @relation("ServiceCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  teams Team[]

  @@index([organizationId])
  @@index([createdById])
  @@map("service")
}

model Team {
  id             Int      @id @default(autoincrement())
  name           String   @db.VarChar(255)
  description    String?
  organizationId Int      @map("organization_id")
  serviceId      Int?     @map("service_id")

  createdById Int?     @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamp(0)

  isDefault Boolean @default(false) @map("is_default")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  service      Service?     @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  createdBy    User?        @relation("TeamCreatedBy", fields: [createdById], references: [id], onDelete: SetNull)

  userTeams UserTeam[]

  @@index([organizationId])
  @@index([serviceId])
  @@index([createdById])
  @@map("team")
}

model Role {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(191)

  rolePermissions       RolePermission[]
  userOrganizationRoles UserOrganizationRole[]

  @@map("role")
}

model Permission {
  id   Int    @id @default(autoincrement())
  name String @unique @db.VarChar(191)

  rolePermissions RolePermission[]

  @@map("permission")
}       

model RolePermission {
  roleId       Int @map("role_id")
  permissionId Int @map("permission_id")

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@id([roleId, permissionId])
  @@index([permissionId])
  @@map("role_permission")
}

model UserBadge {
  userId     Int      @map("user_id")
  badgeId    Int      @map("badge_id")
  assignedAt DateTime @default(now()) @map("assigned_at") @db.Timestamp(0)

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@id([userId, badgeId])
  @@index([badgeId])
  @@map("user_badge")
}

model UserTeam {
  userId   Int      @map("user_id")
  teamId   Int      @map("team_id")
  joinedAt DateTime @default(now()) @map("joined_at") @db.Timestamp(0)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@id([userId, teamId])
  @@index([teamId])
  @@map("user_team")
}

model UserOrganizationRole {
  userId         Int      @map("user_id")
  organizationId Int      @map("organization_id")
  roleId         Int      @map("role_id")
  joinedAt       DateTime @default(now()) @map("joined_at") @db.Timestamp(0)

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade) 
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role         Role         @relation(fields: [roleId], references: [id], onDelete: Restrict)

  @@unique([userId, organizationId])
  @@index([organizationId])
  @@index([roleId])
  @@map("user_organization_role")
}
